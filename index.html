<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Printing Mcd.1</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>22-11-2025</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated Meta Tag for Mobile Web App -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <title>GMS COMPOSITE KNITTING IND LTD</title>

    <!-- Firebase SDK (Compatible Version) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Tailwind & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- CSS Styles --- */
        body { box-sizing: border-box; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; color: #1a1a1a; }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        .login-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-logo {
            height: 80px;
            width: auto;
            display: block;
            margin: 0 auto 20px auto;
            object-fit: contain;
        }
        .login-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 30px;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .login-input {
            padding: 12px 15px;
            border: 1.5px solid #d0d7de;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        .login-input:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }
        .login-btn {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .login-btn:hover {
            background: #152d5a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.3);
        }
        .login-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        .app-container {
            display: none;
        }

        /* Navbar */
        .navbar { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 1000; }
        .navbar h1 { font-size: 22px; font-weight: 600; letter-spacing: 0.5px; display: flex; align-items: center; gap: 15px; }
        .navbar-logo { height: 45px; width: auto; object-fit: contain; }
        .nav-menu { display: flex; gap: 5px; flex-wrap: wrap; }
        .nav-btn { background: rgba(255,255,255,0.15); color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .nav-btn:hover { background: rgba(255,255,255,0.25); transform: translateY(-2px); }
        .nav-btn.active { background: white; color: #1e3c72; }

        /* Layout */
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; min-height: calc(100% - 70px); }
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Forms */
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 25px; }
        .card-header { font-size: 20px; font-weight: 600; color: #1e3c72; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e8eaf0; display: flex; justify-content: space-between; align-items: center; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-size: 13px; font-weight: 600; color: #555; margin-bottom: 6px; }
        .form-input, .form-select { padding: 10px 12px; border: 1.5px solid #d0d7de; border-radius: 8px; font-size: 14px; transition: all 0.3s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #1e3c72; box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1); }
        .form-input[readonly] { background: #f6f8fa; cursor: not-allowed; }

        /* Buttons */
        .btn { padding: 11px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #1e3c72; color: white; }
        .btn-primary:hover { background: #152d5a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30, 60, 114, 0.3); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover { background: #e0a800; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-sm { padding: 6px 14px; font-size: 12px; }

        /* Tables */
        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; }
        th { padding: 12px 10px; text-align: left; font-size: 12px; font-weight: 600; white-space: nowrap; }
        td { padding: 10px; border-bottom: 1px solid #e8eaf0; font-size: 13px; }
        tbody tr:hover { background: #f8f9fa; }
        .table-input { width: 100%; padding: 6px 8px; border: 1px solid #d0d7de; border-radius: 5px; font-size: 12px; }
        .table-input:focus { outline: none; border-color: #1e3c72; }

        /* Stats & Badges */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .stat-card h3 { font-size: 14px; font-weight: 500; margin-bottom: 12px; opacity: 0.9; }
        .stat-card .value { font-size: 36px; font-weight: 700; }
        .badge { display: inline-block; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge-pending { background: #ffc107; color: #000; }
        .badge-billed { background: #28a745; color: white; }

        /* Toast */
        .toast { position: fixed; top: 90px; right: 20px; background: #28a745; color: white; padding: 16px 22px; border-radius: 10px; box-shadow: 0 6px 16px rgba(0,0,0,0.2); z-index: 10000; animation: slideIn 0.3s ease; font-weight: 500; }
        .toast.error { background: #dc3545; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Summary Box */
        .summary-box { background: #f8f9fa; padding: 15px 20px; border-radius: 10px; margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .summary-item { text-align: center; }
        .summary-item label { font-size: 12px; color: #666; font-weight: 600; display: block; margin-bottom: 5px; }
        .summary-item strong { font-size: 20px; color: #1e3c72; display: block; }

        /* Modal & Print Area */
        #print-area { display: none; }
        .preview-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: none; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        .preview-modal.active { display: flex; }
        .preview-content { background: white; width: 100%; max-width: 900px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); position: relative; max-height: 90%; overflow-y: auto; }
        .preview-header { background: #1e3c72; color: white; padding: 20px 30px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .preview-body { padding: 30px; background: white; }
        .preview-close, .preview-print { border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .preview-close { background: rgba(255, 255, 255, 0.2); color: white; }
        .preview-print { background: white; color: #1e3c72; padding: 10px 24px; }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block; }
            
            .print-page { padding: 30px; width: 100%; min-height: 98vh; position: relative; }
            .page-break { page-break-before: always; break-before: page; display: block; height: 1px; }
            .print-header { border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px; color: #000; }
            .print-details { margin-bottom: 20px; color: #000; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 6px; font-size: 11px; color: #000; }
            .print-table th { background: #f0f0f0; }
            .print-footer { margin-top: 60px; color: #000; }
            .copy-label { position: absolute; top: 10px; right: 20px; border: 1px solid #000; padding: 5px 10px; font-weight: bold; font-size: 12px; text-transform: uppercase; }
        }

        .bill-step { display: none; }
        .bill-step.active { display: block; }
    </style>
</head>
<body>

<!-- Login Container -->
<div id="login-container" class="login-container">
    <div class="login-card">
        <img src="https://logic.gmsbd.com/platform/file_upload/company_details_1_5639_0.jpg" alt="Company Logo" class="login-logo" onerror="this.style.display='none'">
        <h2 class="login-title">GMS COMPOSITE KNITTING IND LTD</h2>
        <form id="login-form" class="login-form">
            <input type="text" id="username" class="login-input" placeholder="Username" required>
            <input type="password" id="password" class="login-input" placeholder="Password" required>
            <button type="submit" class="login-btn">Login</button>
            <div id="login-error" class="login-error">Invalid username or password</div>
        </form>
    </div>
</div>

<!-- Application Container -->
<div id="app-container" class="app-container">

<!-- Navigation Bar -->
<nav class="navbar">
    <h1 id="company-title">
        <img src="https://logic.gmsbd.com/platform/file_upload/company_details_1_5639_0.jpg" alt="Logo" class="navbar-logo" onerror="this.style.display='none'">
        <div style="display: flex; flex-direction: column;">
            <span>GMS COMPOSITE KNITTING IND LTD</span>
            <span style="font-size: 12px; font-weight: 400; opacity: 0.9;">Sardagonj, Kashimpur, Gazipur</span>
        </div>
    </h1>
    <div class="nav-menu">
        <button class="nav-btn active" onclick="showView('dashboard')"><i class="fas fa-home"></i> Dashboard</button>
        <button class="nav-btn" onclick="showView('challanEntry')"><i class="fas fa-plus-circle"></i> Challan Entry</button>
        <button class="nav-btn" onclick="showView('challanList')"><i class="fas fa-list"></i> Challan List</button>
        <button class="nav-btn" onclick="showView('billGenerate')"><i class="fas fa-file-invoice-dollar"></i> Bill Generate</button>
        <button class="nav-btn" onclick="showView('billList')"><i class="fas fa-receipt"></i> Bill List</button>
        <button class="nav-btn" onclick="showView('reports')"><i class="fas fa-chart-bar"></i> Reports</button>
        <button class="nav-btn" onclick="showView('partySetup')"><i class="fas fa-users"></i> Party Setup</button>
        <button class="nav-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
</nav>

<div class="container">

    <!-- Dashboard View -->
    <section id="dashboard-view" class="view-section active">
        <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <img src="https://logic.gmsbd.com/platform/file_upload/company_details_1_5639_0.jpg" alt="Company Logo" style="height: 100px; width: auto; object-fit: contain;" onerror="this.style.display='none'">
        </div>
        <div class="stats-grid">
            <div class="stat-card"><h3>Total Challans</h3><div class="value" id="dash-challan-count">0</div></div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><h3>Pending Challans</h3><div class="value" id="dash-pending-count">0</div></div>
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><h3>Total Bills</h3><div class="value" id="dash-bill-count">0</div></div>
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);"><h3>Total Parties</h3><div class="value" id="dash-party-count">0</div></div>
        </div>
    </section>

    <!-- Challan Entry View -->
    <section id="challanEntry-view" class="view-section">
        <div class="card">
            <div class="card-header">
                <span id="challan-entry-title">üìù New Challan Entry</span> 
                <div id="challan-actions">
                    <button class="btn btn-secondary" id="cancel-edit-btn" style="display:none; margin-right: 10px;" onclick="resetChallanForm()">Cancel</button>
                    <button class="btn btn-success" id="save-challan-btn" onclick="saveChallan()"><i class="fas fa-save"></i> Save Challan</button>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Challan No (Auto)</label> <input type="text" id="c_no" class="form-input" readonly></div>
                <div class="form-group"><label class="form-label">Date</label> <input type="date" id="c_date" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Party</label> <select id="c_party" class="form-select" required> <option value="">Select Party</option> </select></div>
                <div class="form-group"><label class="form-label">Location</label> <input type="text" id="c_location" class="form-input"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Department</label> <input type="text" id="c_department" class="form-input"></div>
                <div class="form-group"><label class="form-label">Buyer Name</label> <input type="text" id="c_buyer" class="form-input"></div>
                <div class="form-group"><label class="form-label">Gate Pass No</label> <input type="text" id="c_gate" class="form-input"></div>
                <div class="form-group"><label class="form-label">Transport No</label> <input type="text" id="c_transport" class="form-input"></div>
            </div>
            <div class="form-row">
                <div class="form-group" style="grid-column: span 2;"><label class="form-label">Address</label> <input type="text" id="c_address" class="form-input"></div>
                <div class="form-group"><label class="form-label">Driver No</label> <input type="text" id="c_driver" class="form-input"></div>
            </div>
            <!-- Items -->
            <div class="card-header" style="margin-top: 30px;"><span>üì¶ Challan Items</span> <button class="btn btn-primary btn-sm" onclick="addChallanItem()"><i class="fas fa-plus"></i> Add Item</button></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th style="width: 40px;">#</th><th>Style/Order</th><th>Item Name</th><th>Lot</th><th>Color</th><th>UOM</th><th>PCS</th><th>Raw KG</th><th>Finish KG</th><th>Bag</th><th>SR NO</th><th>Process</th><th>Remarks</th><th><i class="fas fa-times"></i></th></tr>
                    </thead>
                    <tbody id="challan-items-tbody"><tr><td colspan="14" style="text-align: center; color: #999;">Click "Add Item" to add items</td></tr></tbody>
                </table>
            </div>
            <div class="summary-box">
                <div class="summary-item"><label>Total PCS</label> <strong id="sum_pcs">0</strong></div>
                <div class="summary-item"><label>Total Raw KG</label> <strong id="sum_raw">0.00</strong></div>
                <div class="summary-item"><label>Total Finish KG</label> <strong id="sum_finish">0.00</strong></div>
                <div class="summary-item"><label>Total Bags</label> <strong id="sum_bags">0</strong></div>
            </div>
        </div>
    </section>

    <!-- Challan List View -->
    <section id="challanList-view" class="view-section">
        <div class="card">
            <div class="card-header"><span>üìú Challan History</span></div>
            <div class="search-bar" style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="search-challan" class="form-input" placeholder="Search by Challan No, Party..." onkeyup="filterChallans()">
                <input type="date" id="search-challan-from" class="form-input" onchange="filterChallans()">
                <input type="date" id="search-challan-to" class="form-input" onchange="filterChallans()">
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Challan No</th><th>Date</th><th>Party</th><th>Buyer</th><th>Total PCS</th><th>Total Finish KG</th><th>Total Bags</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="challan-list-tbody"><tr><td colspan="9" style="text-align: center; color: #999;">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Bill Generate View -->
    <section id="billGenerate-view" class="view-section">
        <div id="bill-step-1" class="bill-step active">
            <div class="card">
                <div class="card-header"><span>üí∞ Generate Bill - <span class="badge" style="background: #1e3c72; color: white;">Step 1: Select Challans</span></span></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Select Party</label> <select id="bill_party" class="form-select" onchange="loadPendingChallansForBill()"> <option value="">Select Party</option> </select></div>
                    <div class="form-group"><label class="form-label">Month (Optional)</label> <input type="month" id="bill_month" class="form-input"></div>
                    <div class="form-group"><button class="btn btn-primary" style="margin-top: 28px;" onclick="loadPendingChallansForBill()"><i class="fas fa-search"></i> Find Challans</button></div>
                </div>
                <div class="table-container" id="pending-challans-container" style="display: none;">
                    <table>
                        <thead><tr><th style="width: 50px;"><input type="checkbox" id="select-all-bill-challans" onchange="toggleAllBillChallans()"></th><th>Challan No</th><th>Date</th><th>Location</th><th>Total PCS</th><th>Total Finish KG</th><th>Total Bags</th></tr></thead>
                        <tbody id="pending-challans-tbody"></tbody>
                    </table>
                </div>
                <button class="btn btn-success" style="margin-top: 20px; float: right;" onclick="proceedToRateEntry()"> <i class="fas fa-arrow-right"></i> Next: Rate Entry </button>
                <div style="clear: both;"></div>
            </div>
        </div>
        <div id="bill-step-2" class="bill-step">
            <div class="card">
                <div class="card-header"><span>üí∞ Generate Bill - <span class="badge" style="background: #28a745; color: white;">Step 2: Rate & Finalize</span></span> <button class="btn btn-warning" onclick="backToStep1()"><i class="fas fa-arrow-left"></i> Back</button></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Party</label> <input type="text" id="bp_name" class="form-input" readonly></div>
                    <div class="form-group"><label class="form-label">Bill No (Auto)</label> <input type="text" id="bp_no" class="form-input" readonly></div>
                    <div class="form-group"><label class="form-label">Bill Date</label> <input type="date" id="bp_date" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Month</label> <input type="month" id="bp_month" class="form-input"></div>
                </div>
                <div class="card-header" style="margin-top: 20px;"><span>Selected Challans: <span id="selected-challan-nos"></span></span></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Item Name / Style</th><th>UOM</th><th>Total PCS</th><th>Total KG</th><th style="width: 100px;">LBS</th><th style="width: 100px;">Currency</th><th style="width: 120px;">Rate</th><th style="width: 150px;">Amount</th></tr></thead>
                        <tbody id="bill-rate-tbody"></tbody>
                        <tfoot>
                            <tr style="background: #f8f9fa; font-weight: 600;"><td colspan="6" style="text-align: right; padding-right: 20px;">Sub Total:</td><td><input type="number" id="b_subtotal" class="form-input" readonly></td></tr>
                            <tr style="background: #f8f9fa;"><td colspan="6" style="text-align: right; padding-right: 20px;">Order Qty Note:</td><td><input type="text" id="b_order_qty_note" class="form-input"></td></tr>
                            <tr style="background: #1e3c72; color: white; font-weight: 700; font-size: 16px;"><td colspan="6" style="text-align: right; padding-right: 20px;">Net Total:</td><td><input type="number" id="b_nettotal" class="form-input" readonly style="font-weight: 700; font-size: 16px;"></td></tr>
                            <tr style="background: #f0f0f0;"><td colspan="6" style="text-align: right; padding-right: 20px; font-weight: 600;">Amount in Words:</td><td colspan="1"><input type="text" id="b_amount_words" class="form-input" readonly></td></tr>
                        </tfoot>
                    </table>
                </div>
                <button class="btn btn-success" style="margin-top: 20px; float: right; font-size: 16px; padding: 14px 30px;" onclick="saveBill()"> <i class="fas fa-save"></i> Save & Generate Bill </button>
                <div style="clear: both;"></div>
            </div>
        </div>
    </section>

    <!-- Bill List View -->
    <section id="billList-view" class="view-section">
        <div class="card">
            <div class="card-header"><span>üßæ Bill History</span></div>
            <div class="search-bar" style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="search-bill" class="form-input" placeholder="Search by Bill No, Party..." onkeyup="filterBills()">
                <input type="month" id="search-bill-month" class="form-input" onchange="filterBills()">
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Bill No</th><th>Date</th><th>Party</th><th>Month</th><th>Challans</th><th>Net Total</th><th>Actions</th></tr></thead>
                    <tbody id="bill-list-tbody"><tr><td colspan="7" style="text-align: center; color: #999;">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Reports View -->
    <section id="reports-view" class="view-section">
        <div class="card">
            <div class="card-header"><span>üìä Reports & Summary</span> <button class="btn btn-primary btn-sm" onclick="generateReports()"><i class="fas fa-sync"></i> Refresh</button></div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3 style="font-size: 16px; font-weight:600; color:#1e3c72; margin-bottom:10px;">Party Wise Bill Summary</h3>
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead><tr><th>Party Name</th><th>Total Bills</th><th>Total Amount</th></tr></thead>
                            <tbody id="report-party-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h3 style="font-size: 16px; font-weight:600; color:#1e3c72; margin-bottom:10px;">Monthly Sales Summary</h3>
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead><tr><th>Month</th><th>Bills Count</th><th>Total Amount</th></tr></thead>
                            <tbody id="report-month-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Party Setup View -->
    <section id="partySetup-view" class="view-section">
        <div class="card">
            <div class="card-header"><span>üë• Add New Party</span></div>
            <form id="party-form">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Party Name *</label> <input type="text" id="party-name" class="form-input" required></div>
                    <div class="form-group"><label class="form-label">Contact Person</label> <input type="text" id="party-contact" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Phone</label> <input type="tel" id="party-phone" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Email</label> <input type="email" id="party-email" class="form-input"></div>
                </div>
                <div class="form-group"><label class="form-label">Address</label> <input type="text" id="party-address" class="form-input"></div>
                <button type="submit" class="btn btn-success" style="margin-top:10px;"><i class="fas fa-plus"></i> Add Party</button>
            </form>
        </div>
        <div class="card">
            <div class="card-header"><span>Party List</span></div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Party Name</th><th>Contact Person</th><th>Phone</th><th>Email</th><th>Actions</th></tr></thead>
                    <tbody id="party-list-tbody"><tr><td colspan="5" style="text-align: center; color: #999;">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </section>

</div>

</div>

<!-- Print Area (Hidden) -->
<div id="print-area"></div>

<!-- Preview Modal -->
<div id="preview-modal" class="preview-modal">
    <div class="preview-content">
        <div class="preview-header">
            <h2 id="preview-title">Print Preview</h2>
            <div class="preview-actions">
                <button class="preview-print" onclick="confirmPrint()"><i class="fas fa-print"></i> Print Now</button>
                <button class="preview-close" onclick="closePreview()"><i class="fas fa-times"></i> Close</button>
            </div>
        </div>
        <div class="preview-body" id="preview-body"></div>
    </div>
</div>

<script>
    // --- Firebase Configuration (Using default public test DB) ---
    const firebaseConfig = { databaseURL: "https://printing-mcd-2-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    const defaultConfig = {
        company_name: 'GMS COMPOSITE KNITTING IND LTD',
        company_address: 'Sardagonj, Kashimpur, Gazipur'
    };

    // Default login credentials
    const defaultCredentials = {
        username: 'admin',
        password: 'admin123'
    };

    let parties = [], challans = [], bills = [];
    let currentChallanItems = [], selectedBillChallans = [];
    const itemOptions = ['Com Body', 'Fabrics', 'Approval Sample', 'Zipper', 'Drawstring', 'Woven Label', 'Elastic', 'Shade Card', 'Collar', 'Cuff', 'Rib', 'Piping', 'Twill Tape'];

    // --- Login Functionality ---
    document.addEventListener('DOMContentLoaded', function() {
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            showApp();
        } else {
            showLogin();
        }

        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === defaultCredentials.username && password === defaultCredentials.password) {
                sessionStorage.setItem('isLoggedIn', 'true');
                showApp();
                initApp();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        });
    });

    function showLogin() {
        document.getElementById('login-container').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
    }

    function showApp() {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
    }

    function logout() {
        sessionStorage.removeItem('isLoggedIn');
        showLogin();
    }

    // --- Initialization ---
    function initApp() {
        db.ref('parties').on('value', s => { 
            parties = snapshotToArr(s); 
            renderPartyList(); 
            populatePartyDropdowns(); 
            updateDashboard(); 
        });
        db.ref('challans').on('value', s => { 
            challans = snapshotToArr(s); 
            renderChallanList(); 
            updateDashboard(); 
            if(!editingChallanId) generateChallanNumber(); 
        });
        db.ref('bills').on('value', s => { 
            bills = snapshotToArr(s); 
            renderBillList(); 
            updateDashboard(); 
            generateBillNumber(); 
        });
        
        // --- FIXED: Date setting in JS only, not in HTML attributes ---
        const today = new Date().toISOString().split('T')[0];
        const month = new Date().toISOString().slice(0, 7);
        
        if(document.getElementById('c_date')) document.getElementById('c_date').value = today;
        if(document.getElementById('bp_date')) document.getElementById('bp_date').value = today;
        if(document.getElementById('bp_month')) document.getElementById('bp_month').value = month;
    }

    function snapshotToArr(snapshot) {
        const arr = [];
        if(snapshot && snapshot.exists()){
            snapshot.forEach(child => { let val = child.val(); val.__backendId = child.key; arr.push(val); });
        }
        return arr;
    }

    // --- Navigation ---
    function showView(viewName) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById(`${viewName}-view`).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.closest('button')?.classList.add('active');
        
        if(viewName === 'challanEntry') {
            if(!editingChallanId) resetChallanForm();
        }
        if(viewName === 'billGenerate') { resetBillSteps(); generateBillNumber(); }
        if(viewName === 'reports') { generateReports(); }
    }

    // --- Dashboard Update Logic ---
    function updateDashboard() {
        document.getElementById('dash-challan-count').textContent = challans.length;
        const pendingCount = challans.filter(c => c.status === 'pending').length;
        document.getElementById('dash-pending-count').textContent = pendingCount;
        document.getElementById('dash-bill-count').textContent = bills.length;
        document.getElementById('dash-party-count').textContent = parties.length;
    }

    // --- Logic: Reports ---
    function generateReports() {
        const partyStats = parties.map(p => {
            const pBills = bills.filter(b => b.party_id === p.__backendId);
            const totalAmt = pBills.reduce((sum, b) => sum + (parseFloat(b.net_total)||0), 0);
            return { name: p.party_name, count: pBills.length, total: totalAmt };
        }).sort((a,b) => b.total - a.total); 

        document.getElementById('report-party-tbody').innerHTML = partyStats.map(s => `
            <tr><td>${s.name}</td><td>${s.count}</td><td>${s.total.toFixed(2)}</td></tr>
        `).join('');

        const monthMap = {};
        bills.forEach(b => {
            const m = b.month || 'Unknown';
            if(!monthMap[m]) monthMap[m] = { count: 0, total: 0 };
            monthMap[m].count++;
            monthMap[m].total += (parseFloat(b.net_total)||0);
        });

        const months = Object.keys(monthMap).sort().reverse();
        document.getElementById('report-month-tbody').innerHTML = months.map(m => `
            <tr><td>${m}</td><td>${monthMap[m].count}</td><td>${monthMap[m].total.toFixed(2)}</td></tr>
        `).join('');
    }

    // --- Logic: Party ---
    document.getElementById('party-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const party = {
            party_name: document.getElementById('party-name').value,
            contact: document.getElementById('party-contact').value,
            phone: document.getElementById('party-phone').value,
            email: document.getElementById('party-email').value,
            address: document.getElementById('party-address').value,
            timestamp: Date.now()
        };
        db.ref('parties').push(party).then(() => { showToast('Party added'); this.reset(); });
    });

    function renderPartyList() {
        const tbody = document.getElementById('party-list-tbody');
        if(!parties.length) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No parties</td></tr>'; return; }
        tbody.innerHTML = parties.map(p => `<tr><td><b>${p.party_name}</b></td><td>${p.contact||'-'}</td><td>${p.phone||'-'}</td><td>${p.email||'-'}</td><td><button class="btn btn-danger btn-sm" onclick="deleteRecord('${p.__backendId}','party')">Delete</button></td></tr>`).join('');
    }
    function populatePartyDropdowns() {
        const opts = '<option value="">Select Party</option>' + parties.map(p => `<option value="${p.__backendId}">${p.party_name}</option>`).join('');
        document.getElementById('c_party').innerHTML = opts;
        document.getElementById('bill_party').innerHTML = opts;
        if(editingChallanId) {
             const c = challans.find(x => x.__backendId === editingChallanId);
             if(c) document.getElementById('c_party').value = c.party_id;
        }
    }

    // --- Logic: Challan ---
    function generateChallanNumber() { 
        if(editingChallanId) return;
        document.getElementById('c_no').value = `GMS-CH-${new Date().getFullYear()}-${String(challans.length+1).padStart(5,'0')}`; 
    }
    
    let itemCounter = 0;
    function addChallanItem(data = null) {
        itemCounter++;
        const itemId = Date.now() + itemCounter;
        const row = document.createElement('tr');
        row.dataset.itemId = itemId;
        
        const val = {
            style: data ? data.style : '',
            item_name: data ? data.item_name : '',
            lot: data ? data.lot : '',
            color: data ? data.color : '',
            uom: data ? data.uom : 'PCS',
            pcs: data ? data.pcs : '',
            raw_kg: data ? data.raw_kg : '',
            finish_kg: data ? data.finish_kg : '',
            bag: data ? data.bag : '',
            ashar_no: data ? data.ashar_no : '',
            process: data ? data.process : '',
            remarks: data ? data.remarks : ''
        };

        row.innerHTML = `
            <td>${currentChallanItems.length + 1}</td>
            <td><input type="text" class="table-input" data-field="style" placeholder="Style" value="${val.style}"></td>
            <td><input type="text" class="table-input" data-field="item_name" list="list-${itemId}" placeholder="Item" value="${val.item_name}"><datalist id="list-${itemId}">${itemOptions.map(o=>`<option value="${o}">`).join('')}</datalist></td>
            <td><input type="text" class="table-input" data-field="lot" placeholder="Lot" value="${val.lot}"></td>
            <td><input type="text" class="table-input" data-field="color" placeholder="Color" value="${val.color}"></td>
            <td><select class="table-input" data-field="uom">
                <option ${val.uom==='PCS'?'selected':''}>PCS</option>
                <option ${val.uom==='KG'?'selected':''}>KG</option>
                <option ${val.uom==='YDS'?'selected':''}>YDS</option>
                <option ${val.uom==='DZN'?'selected':''}>DZN</option>
                <option ${val.uom==='LBS'?'selected':''}>LBS</option>
            </select></td>
            <td><input type="number" class="table-input" data-field="pcs" placeholder="0" step="1" value="${val.pcs}" oninput="calculateChallanTotals()"></td>
            <td><input type="number" class="table-input" data-field="raw_kg" placeholder="0.00" step="0.01" value="${val.raw_kg}" oninput="calculateChallanTotals()"></td>
            <td><input type="number" class="table-input" data-field="finish_kg" placeholder="0.00" step="0.01" value="${val.finish_kg}" oninput="calculateChallanTotals()"></td>
            <td><input type="number" class="table-input" data-field="bag" placeholder="0" step="1" value="${val.bag}" oninput="calculateChallanTotals()"></td>
            <td><input type="text" class="table-input" data-field="ashar_no" placeholder="SR" value="${val.ashar_no}"></td>
            <td><input type="text" class="table-input" data-field="process" placeholder="Proc" value="${val.process}"></td>
            <td><input type="text" class="table-input" data-field="remarks" placeholder="Rem" value="${val.remarks}"></td>
            <td><button class="btn btn-danger btn-sm" onclick="removeChallanItem(${itemId})"><i class="fas fa-trash"></i></button></td>
        `;
        const tbody = document.getElementById('challan-items-tbody');
        if(currentChallanItems.length === 0) tbody.innerHTML = '';
        tbody.appendChild(row);
        currentChallanItems.push({itemId});
        if(data) calculateChallanTotals();
    }

    function removeChallanItem(id) {
        document.querySelector(`tr[data-item-id="${id}"]`)?.remove();
        currentChallanItems = currentChallanItems.filter(i => i.itemId !== id);
        calculateChallanTotals();
        if(!currentChallanItems.length) document.getElementById('challan-items-tbody').innerHTML = '<tr><td colspan="14" style="text-align: center; color: #999;">Click "Add Item" to add items</td></tr>';
    }

    function calculateChallanTotals() {
        let tPcs=0, tRaw=0, tFin=0, tBag=0;
        document.querySelectorAll('#challan-items-tbody tr').forEach(r => {
            tPcs += parseFloat(r.querySelector('[data-field="pcs"]')?.value)||0;
            tRaw += parseFloat(r.querySelector('[data-field="raw_kg"]')?.value)||0;
            tFin += parseFloat(r.querySelector('[data-field="finish_kg"]')?.value)||0;
            tBag += parseFloat(r.querySelector('[data-field="bag"]')?.value)||0;
        });
        document.getElementById('sum_pcs').textContent = tPcs;
        document.getElementById('sum_raw').textContent = tRaw.toFixed(2);
        document.getElementById('sum_finish').textContent = tFin.toFixed(2);
        document.getElementById('sum_bags').textContent = tBag;
    }

    function saveChallan() {
        const partyId = document.getElementById('c_party').value;
        if(!partyId) return showToast('Select Party', 'error');
        if(!currentChallanItems.length) return showToast('Add Items', 'error');

        const items = [];
        document.querySelectorAll('#challan-items-tbody tr').forEach(r => {
            items.push({
                style: r.querySelector('[data-field="style"]').value,
                item_name: r.querySelector('[data-field="item_name"]').value,
                lot: r.querySelector('[data-field="lot"]').value,
                color: r.querySelector('[data-field="color"]').value,
                uom: r.querySelector('[data-field="uom"]').value,
                pcs: parseFloat(r.querySelector('[data-field="pcs"]').value)||0,
                raw_kg: parseFloat(r.querySelector('[data-field="raw_kg"]').value)||0,
                finish_kg: parseFloat(r.querySelector('[data-field="finish_kg"]').value)||0,
                bag: parseFloat(r.querySelector('[data-field="bag"]').value)||0,
                ashar_no: r.querySelector('[data-field="ashar_no"]').value,
                process: r.querySelector('[data-field="process"]').value,
                remarks: r.querySelector('[data-field="remarks"]').value
            });
        });

        const challan = {
            challan_no: document.getElementById('c_no').value,
            date: document.getElementById('c_date').value,
            party_id: partyId,
            party_name: parties.find(p=>p.__backendId===partyId)?.party_name,
            location: document.getElementById('c_location').value,
            department: document.getElementById('c_department').value,
            buyer_name: document.getElementById('c_buyer').value,
            address: document.getElementById('c_address').value,
            gate_pass: document.getElementById('c_gate').value,
            transport_no: document.getElementById('c_transport').value,
            driver_no: document.getElementById('c_driver').value,
            items: JSON.stringify(items),
            total_pcs: parseFloat(document.getElementById('sum_pcs').textContent),
            total_finish_kg: parseFloat(document.getElementById('sum_finish').textContent),
            total_bags: parseFloat(document.getElementById('sum_bags').textContent),
            status: editingChallanId ? (challans.find(c=>c.__backendId===editingChallanId)?.status || 'pending') : 'pending',
            timestamp: Date.now()
        };

        let promise;
        let newKey;
        if(editingChallanId) {
            promise = db.ref('challans/'+editingChallanId).update(challan);
            newKey = editingChallanId;
        } else {
            const ref = db.ref('challans').push();
            newKey = ref.key;
            promise = ref.set(challan);
        }

        promise.then(() => {
            showToast(editingChallanId ? 'Challan Updated' : 'Challan Saved');
            if(!editingChallanId) printChallan(newKey);
            resetChallanForm();
        }).catch(e => showToast(e.message, 'error'));
    }

    function resetChallanForm() {
        editingChallanId = null;
        document.getElementById('c_no').value = '';
        generateChallanNumber();
        
        // --- FIXED: Date reset in JS only ---
        document.getElementById('c_date').value = new Date().toISOString().split('T')[0];
        
        document.getElementById('c_party').value = '';
        document.getElementById('c_location').value = '';
        document.getElementById('c_department').value = '';
        document.getElementById('c_buyer').value = '';
        document.getElementById('c_address').value = '';
        document.getElementById('c_gate').value = '';
        document.getElementById('c_transport').value = '';
        document.getElementById('c_driver').value = '';
        
        document.getElementById('challan-items-tbody').innerHTML = '<tr><td colspan="14" style="text-align:center">Add Items</td></tr>';
        currentChallanItems = [];
        calculateChallanTotals();
        
        document.getElementById('challan-entry-title').textContent = 'üìù New Challan Entry';
        document.getElementById('save-challan-btn').innerHTML = '<i class="fas fa-save"></i> Save Challan';
        document.getElementById('cancel-edit-btn').style.display = 'none';
    }

    function renderChallanList() {
        const tbody = document.getElementById('challan-list-tbody');
        if(!challans.length) { tbody.innerHTML = '<tr><td colspan="9" style="text-align:center">No Challans</td></tr>'; return; }
        tbody.innerHTML = challans.sort((a,b)=>b.timestamp-a.timestamp).map(c => `
            <tr>
                <td>${c.challan_no}</td><td>${c.date}</td><td>${c.party_name}</td><td>${c.buyer_name||'-'}</td>
                <td>${c.total_pcs}</td><td>${c.total_finish_kg.toFixed(2)}</td><td>${c.total_bags}</td>
                <td><span class="badge ${c.status==='pending'?'badge-pending':'badge-billed'}">${c.status.toUpperCase()}</span></td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="printChallan('${c.__backendId}')"><i class="fas fa-print"></i></button>
                    ${c.status==='pending' ? `<button class="btn btn-warning btn-sm" onclick="editChallan('${c.__backendId}')"><i class="fas fa-edit"></i></button>`:''}
                </td>
            </tr>
        `).join('');
    }

    // --- Search/Filter ---
    function filterChallans() {
        const text = document.getElementById('search-challan').value.toLowerCase();
        const fromDate = document.getElementById('search-challan-from').value;
        const toDate = document.getElementById('search-challan-to').value;
        const rows = document.querySelectorAll('#challan-list-tbody tr');
        rows.forEach(row => {
            if(row.cells.length < 3) return;
            const cNo = row.cells[0].innerText.toLowerCase();
            const cDate = row.cells[1].innerText;
            const cParty = row.cells[2].innerText.toLowerCase();
            const cBuyer = row.cells[3].innerText.toLowerCase();
            let matchesText = (cNo.includes(text) || cParty.includes(text) || cBuyer.includes(text));
            let matchesDate = true;
            if(fromDate && cDate < fromDate) matchesDate = false;
            if(toDate && cDate > toDate) matchesDate = false;
            row.style.display = (matchesText && matchesDate) ? '' : 'none';
        });
    }

    function filterBills() {
        const text = document.getElementById('search-bill').value.toLowerCase();
        const month = document.getElementById('search-bill-month').value;
        const rows = document.querySelectorAll('#bill-list-tbody tr');
        rows.forEach(row => {
            if(row.cells.length < 3) return;
            const bNo = row.cells[0].innerText.toLowerCase();
            const bParty = row.cells[2].innerText.toLowerCase();
            const bMonth = row.cells[3].innerText;
            let matchesText = (bNo.includes(text) || bParty.includes(text));
            let matchesMonth = true;
            if(month && bMonth !== month) matchesMonth = false;
            row.style.display = (matchesText && matchesMonth) ? '' : 'none';
        });
    }

    // --- Bill Logic ---
    function generateBillNumber() { document.getElementById('bp_no').value = `GMS-BILL-${new Date().getFullYear()}-${String(bills.length+1).padStart(5,'0')}`; }
    function resetBillSteps() {
        document.getElementById('bill-step-1').classList.add('active');
        document.getElementById('bill-step-2').classList.remove('active');
        document.getElementById('pending-challans-container').style.display = 'none';
        selectedBillChallans = [];
    }
    function loadPendingChallansForBill() {
        const pid = document.getElementById('bill_party').value;
        if(!pid) return showToast('Select Party', 'error');
        const filtered = challans.filter(c => c.party_id === pid && c.status === 'pending');
        if(!filtered.length) return showToast('No pending challans', 'error');
        
        document.getElementById('pending-challans-tbody').innerHTML = filtered.map(c => `
            <tr>
                <td><input type="checkbox" class="bill-chk" data-id="${c.__backendId}"></td>
                <td>${c.challan_no}</td><td>${c.date}</td><td>${c.location||'-'}</td><td>${c.total_pcs}</td><td>${c.total_finish_kg}</td><td>${c.total_bags}</td>
            </tr>
        `).join('');
        document.getElementById('pending-challans-container').style.display = 'block';
    }
    
    function toggleAllBillChallans() {
        const mainChk = document.getElementById('select-all-bill-challans');
        document.querySelectorAll('.bill-chk').forEach(chk => chk.checked = mainChk.checked);
    }
function proceedToRateEntry() {
        const chks = document.querySelectorAll('.bill-chk:checked');
        if(!chks.length) return showToast('Select at least one challan', 'error');
        
        selectedBillChallans = Array.from(chks).map(box => challans.find(c => c.__backendId === box.dataset.id));
        
        document.getElementById('bp_name').value = selectedBillChallans[0].party_name;
        document.getElementById('selected-challan-nos').textContent = selectedBillChallans.map(c=>c.challan_no).join(', ');
        
        const map = new Map();
        selectedBillChallans.forEach(c => {
            JSON.parse(c.items).forEach(i => {
                const key = `${i.item_name}_${i.style}_${i.uom}`;
                if(!map.has(key)) map.set(key, { ...i, pcs:0, finish_kg:0 });
                const ex = map.get(key);
                ex.pcs += i.pcs;
                ex.finish_kg += i.finish_kg;
            });
        });

        document.getElementById('bill-rate-tbody').innerHTML = Array.from(map.values()).map((i, idx) => `
            <tr>
                <td>${i.item_name} ${i.style?'/ '+i.style:''}</td><td>${i.uom}</td><td>${i.pcs}</td><td>${i.finish_kg.toFixed(2)}</td>
                <td><input type="number" class="table-input lbs-inp" placeholder="0.00"></td>
                <!-- ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶≤‡¶æ‡¶á‡¶®‡ßá onchange ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá -->
                <td><select class="table-input cur-inp" onchange="calcTotal()"><option>‡ß≥</option><option>$</option></select></td>
                <td><input type="number" class="table-input rate-inp" data-kg="${i.finish_kg}" oninput="calcRow(this)"></td>
                <td><input type="number" class="table-input amt-inp" oninput="calcTotal()"></td>
            </tr>
        `).join('');
        
        document.getElementById('bill-step-1').classList.remove('active');
        document.getElementById('bill-step-2').classList.add('active');
        
        // ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
        calcTotal();
    }
      function calcTotal() {
        let sub = 0;
        document.querySelectorAll('.amt-inp').forEach(i => sub += parseFloat(i.value)||0);
        document.getElementById('b_subtotal').value = sub.toFixed(2);
        document.getElementById('b_nettotal').value = sub.toFixed(2);
        
        // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∞‡ßã (Row) ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏‡¶ø ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
        const firstRowCurrency = document.querySelector('.cur-inp')?.value;
        const currencyName = (firstRowCurrency === '$') ? 'Dollars' : 'Taka';
        
        document.getElementById('b_amount_words').value = numberToWords(sub, currencyName);
    }
    
    function backToStep1() {
        document.getElementById('bill-step-2').classList.remove('active');
        document.getElementById('bill-step-1').classList.add('active');
    }

    function saveBill() {
        if(!selectedBillChallans.length) return showToast('No challans selected', 'error');
        
        const items = [];
        document.querySelectorAll('#bill-rate-tbody tr').forEach(r => {
            items.push({
                rate: parseFloat(r.querySelector('.rate-inp').value)||0,
                amount: parseFloat(r.querySelector('.amt-inp').value)||0,
                currency: r.querySelector('.cur-inp').value,
                lbs: parseFloat(r.querySelector('.lbs-inp').value)||0
            });
        });

        const bill = {
            bill_no: document.getElementById('bp_no').value,
            date: document.getElementById('bp_date').value,
            month: document.getElementById('bp_month').value,
            party_id: selectedBillChallans[0].party_id,
            party_name: document.getElementById('bp_name').value,
            challan_ids: JSON.stringify(selectedBillChallans.map(c=>c.__backendId)),
            challan_nos: document.getElementById('selected-challan-nos').textContent,
            sub_total: parseFloat(document.getElementById('b_subtotal').value),
            net_total: parseFloat(document.getElementById('b_nettotal').value),
            amount_in_words: document.getElementById('b_amount_words').value,
            order_qty_note: document.getElementById('b_order_qty_note').value,
            bill_items: JSON.stringify(items),
            timestamp: Date.now()
        };

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

        let promise;
        let newBillKey;

        if(editingBillId) {
            newBillKey = editingBillId;
            promise = db.ref('bills/'+editingBillId).update(bill);
            editingBillId = null;
        } else {
            const newRef = db.ref('bills').push();
            newBillKey = newRef.key;
            promise = newRef.set(bill).then(() => {
                const updates = {};
                selectedBillChallans.forEach(c => updates[`challans/${c.__backendId}/status`] = 'billed');
                return db.ref().update(updates);
            });
        }

        promise.then(() => {
            showToast('Bill Generated Successfully!');
            printBill(newBillKey);
            showView('billList');
        }).catch(e => {
            showToast('Error: '+e.message, 'error');
        }).finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Save & Generate Bill';
        });
    }

    function renderBillList() {
        const tbody = document.getElementById('bill-list-tbody');
        if(!bills.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No Bills</td></tr>'; return; }
        tbody.innerHTML = bills.sort((a,b)=>b.timestamp-a.timestamp).map(b => `
            <tr>
                <td>${b.bill_no}</td><td>${b.date}</td><td>${b.party_name}</td><td>${b.month}</td><td>${b.challan_nos}</td><td>${b.net_total}</td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="printBill('${b.__backendId}')"><i class="fas fa-print"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('${b.__backendId}','bill')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }

    // --- Print Logic ---
    function getHeader(title) {
        return `
            <div class="print-header" style="display: flex; align-items: center; justify-content: center; position: relative; border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px;">
                <img src="https://logic.gmsbd.com/platform/file_upload/company_details_1_5639_0.jpg" class="print-logo" style="position: absolute; left: 0; height: 70px; width: auto;">
                <div style="text-align: center;">
                    <h1 style="font-size: 26px; font-weight: bold; margin: 0;">${defaultConfig.company_name}</h1>
                    <p style="margin: 2px 0; font-size: 14px;">${defaultConfig.company_address}</p>
                    <h2 style="font-size: 18px; font-weight: bold; margin-top: 5px; text-decoration: underline;">${title}</h2>
                </div>
            </div>
        `;
    }
function printChallan(id) {
        const c = challans.find(x => x.__backendId === id);
        if(!c) return;
        const items = JSON.parse(c.items);
        
        const getPage = (copyType) => `
            <div class="print-page">
                <div class="copy-label">${copyType}</div>
                ${getHeader('DELIVERY CHALLAN')}
                <div class="print-details" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div>
                        <p><strong>Challan No:</strong> ${c.challan_no}</p>
                        <p><strong>Date:</strong> ${c.date}</p>
                        <p><strong>Party:</strong> ${c.party_name}</p>
                        <p><strong>Buyer:</strong> ${c.buyer_name||'-'}</p>
                        <p><strong>Department:</strong> ${c.department||'-'}</p>
                    </div>
                    <div>
                        <p><strong>Address:</strong> ${c.address||'-'}</p>
                        <p><strong>Location:</strong> ${c.location||'-'}</p>
                        <p><strong>Gate Pass:</strong> ${c.gate_pass||'-'}</p>
                        <p><strong>Transport:</strong> ${c.transport_no||'-'}</p>
                        <p><strong>Driver:</strong> ${c.driver_no||'-'}</p>
                    </div>
                </div>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Style</th>
                            <th>Item</th>
                            <th>Lot</th>
                            <th>Color</th>
                            <th>UOM</th>
                            <th>PCS</th>
                            <th>Raw KG</th>
                            <th>Fin KG</th>
                            <th>Bag</th>
                            <th>SR NO</th>
                            <th>Process</th> <!-- Process ‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá -->
                            <th>Rem</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map((i,idx)=>`
                            <tr>
                                <td>${idx+1}</td>
                                <td>${i.style}</td>
                                <td>${i.item_name}</td>
                                <td>${i.lot}</td>
                                <td>${i.color}</td>
                                <td>${i.uom}</td>
                                <td>${i.pcs}</td>
                                <td>${i.raw_kg}</td>
                                <td>${i.finish_kg}</td>
                                <td>${i.bag}</td>
                                <td>${i.ashar_no || '-'}</td>
                                <td>${i.process || '-'}</td> <!-- Process ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá -->
                                <td>${i.remarks}</td>
                            </tr>`).join('')}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" style="text-align:right">TOTAL:</td>
                            <td>${c.total_pcs}</td>
                            <td>-</td>
                            <td>${c.total_finish_kg.toFixed(2)}</td>
                            <td>${c.total_bags}</td>
                            <td></td> <!-- SR NO ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶ò‡¶∞ -->
                            <td></td> <!-- Process ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶ò‡¶∞ -->
                            <td></td> <!-- Remarks ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶ò‡¶∞ -->
                        </tr>
                    </tfoot>
                </table>
                <div class="print-footer">
                    <div style="display:grid; grid-template-columns:repeat(5,1fr); gap:10px; text-align:center; margin-top: 50px;">
                        <div>Prepared</div>
                        <div>Receiver</div>
                        <div>Checked</div>
                        <div>AGM MCD</div>
                        <div>Approved</div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('print-area').innerHTML = getPage("FIRST COPY") + '<div class="page-break"></div>' + getPage("SECOND COPY");
        showPrintPreview('Challan');
    }
    function printBill(id) {
        const b = bills.find(x => x.__backendId === id);
        if(!b) return;
        const challanIds = JSON.parse(b.challan_ids);
        const billItems = JSON.parse(b.bill_items);
        const assocChallans = challans.filter(c => challanIds.includes(c.__backendId));
        let allItems = [];
        let idx = 0;
        assocChallans.forEach(c => {
            JSON.parse(c.items).forEach(i => {
                const bi = billItems[idx] || {};
                allItems.push({ ...i, ...bi, challan_no: c.challan_no });
                idx++;
            });
        });

        const getPage = (copyType) => `
            <div class="print-page">
                <div class="copy-label">${copyType}</div>
                ${getHeader('BILL / INVOICE')}
                <div class="print-details" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div>
                        <p><strong>Bill No:</strong> ${b.bill_no}</p>
                        <p><strong>Date:</strong> ${b.date}</p>
                        <p><strong>Month:</strong> ${b.month}</p>
                    </div>
                    <div>
                        <p><strong>Party:</strong> ${b.party_name}</p>
                        <p><strong>Ref Challans:</strong> ${b.challan_nos}</p>
                    </div>
                </div>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;">#</th>
                            <th style="width: 100px;">Challan No</th>
                            <th>Style</th>
                            <th>Item</th>
                            <th>Color</th>
                            <th>UOM</th>
                            <th>PCS</th>
                            <th>Fin KG</th>
                            <th>LBS</th>
                            <th>Rate</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allItems.map((i,ix)=>`
                            <tr>
                                <td>${ix+1}</td>
                                <td style="font-weight:bold;">${i.challan_no}</td>
                                <td>${i.style}</td>
                                <td>${i.item_name}</td>
                                <td>${i.color}</td>
                                <td>${i.uom}</td>
                                <td>${i.pcs}</td>
                                <td>${i.finish_kg.toFixed(2)}</td>
                                <td>${i.lbs||0}</td>
                                <td>${i.rate}</td>
                                <td>${i.amount}</td>
                            </tr>`).join('')}
                    </tbody>
                    <tfoot>
                        <tr><td colspan="10" style="text-align:right">Total:</td><td>${b.net_total}</td></tr>
                        ${b.order_qty_note ? `<tr><td colspan="11"><strong>Bill According To Order Qty:</strong> ${b.order_qty_note}</td></tr>` : ''}
                        <tr><td colspan="11"><strong>In Words:</strong> ${b.amount_in_words}</td></tr>
                    </tfoot>
                </table>
                 <div class="print-footer">
                    <div style="display:grid; grid-template-columns:repeat(5,1fr); gap:10px; text-align:center; font-size:11px; margin-top: 50px;">
                        <div>Prepared</div>
                        <div>Receiver</div>
                        <div>Checked</div>
                        <div>AGM MCD</div>
                        <div>Approved</div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('print-area').innerHTML = getPage("FIRST COPY") + '<div class="page-break"></div>' + getPage("SECOND COPY");
        showPrintPreview('Bill');
    }

    // --- Utils ---
    let editingChallanId = null;
    let editingBillId = null;

    function editChallan(id) {
        const c = challans.find(x=>x.__backendId===id);
        if(!c) return showToast("Challan not found", "error");

        editingChallanId = id;
        showView('challanEntry');
        
        document.getElementById('c_no').value = c.challan_no;
        document.getElementById('c_date').value = c.date;
        document.getElementById('c_party').value = c.party_id;
        document.getElementById('c_location').value = c.location;
        document.getElementById('c_department').value = c.department;
        document.getElementById('c_buyer').value = c.buyer_name;
        document.getElementById('c_address').value = c.address;
        document.getElementById('c_gate').value = c.gate_pass;
        document.getElementById('c_transport').value = c.transport_no;
        document.getElementById('c_driver').value = c.driver_no;
        
        document.getElementById('challan-items-tbody').innerHTML = '';
        currentChallanItems = [];
        const items = JSON.parse(c.items);
        items.forEach(item => addChallanItem(item));
        calculateChallanTotals();
        
        document.getElementById('challan-entry-title').textContent = 'üìù Edit Challan: ' + c.challan_no;
        document.getElementById('save-challan-btn').innerHTML = '<i class="fas fa-edit"></i> Update Challan';
        document.getElementById('cancel-edit-btn').style.display = 'inline-flex';
        
        showToast('Edit mode loaded');
    }

    function deleteRecord(id, type) {
        if(confirm('Delete this?')) {
            db.ref((type==='party'?'parties':type==='challan'?'challans':'bills')+'/'+id).remove();
        }
    }

    function showToast(msg, type='success') {
        const t = document.createElement('div'); t.className = `toast ${type==='error'?'error':''}`; t.textContent = msg;
        document.body.appendChild(t); setTimeout(()=>t.remove(), 3000);
    }
    function showPrintPreview(title) {
        document.getElementById('preview-title').textContent = title + ' Preview';
        document.getElementById('preview-body').innerHTML = document.getElementById('print-area').innerHTML;
        document.getElementById('preview-modal').classList.add('active');
    }
    function closePreview() { document.getElementById('preview-modal').classList.remove('active'); }
    function confirmPrint() { closePreview(); setTimeout(()=>window.print(), 300); }

function numberToWords(num, currency = 'Taka') {
        if(num===0) return 'Zero ' + currency;
        const a = ['','One ','Two ','Three ','Four ', 'Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
        const b = ['', '', 'Twenty','Thirty','Forty','Fifty', 'Sixty','Seventy','Eighty','Ninety'];
        const n = ('000000000' + parseInt(num)).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
        if(!n) return ''; 
        let str = '';
        str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
        str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
        str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
        str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
        
        str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
        
        // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏‡¶ø ‡¶°‡¶æ‡¶Ø‡¶º‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
        return str + ' ' + currency + ' Only';
    }
</script>
</body>
</html>
    
  </body>
  
</html>
    
  </body>
  
</html>
